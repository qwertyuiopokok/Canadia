
<!DOCTYPE html>
<html lang="fr">
<head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Canadia ‚Äî Comprendre. Structurer. D√©cider.</title>
        <style>
                :root {
                        --primary: #0b3c5d;
                        --secondary: #328cc1;
                        --accent: #d9b310;
                        --bg: #f8f9fc;
                        --card: #ffffff;
                        --text: #1a1a1a;
                        --muted: #666666;
                }
                body.dark {
                        --bg: #121212;
                        --card: #1e1e1e;
                        --text: #f0f0f0;
                        --muted: #aaaaaa;
                }
                body {
                        margin: 0;
                        font-family: system-ui, -apple-system, sans-serif;
                        background: var(--bg);
                        color: var(--text);
                        transition: background 0.3s, color 0.3s;
                }
                header {
                        background: var(--primary);
                        color: white;
                        padding: 1.5rem;
                        text-align: center;
                        font-size: 1.8rem;
                        font-weight: 600;
                        position: relative;
                }
                #theme-toggle {
                        position: absolute;
                        right: 1.5rem;
                        top: 1.5rem;
                        background: none;
                        border: none;
                        color: white;
                        font-size: 1.5rem;
                        cursor: pointer;
                }
                main {
                        max-width: 900px;
                        margin: 2rem auto;
                        padding: 0 1rem;
                }
                .card {
                        background: var(--card);
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 2rem;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
                }
                h2 {
                        margin-top: 0;
                        color: var(--primary);
                }
                .mode-buttons {
                        display: flex;
                        gap: 1rem;
                        margin-bottom: 1rem;
                }
                .mode-buttons button {
                        flex: 1;
                        padding: 1rem;
                        font-size: 1.1rem;
                        border: 2px solid var(--secondary);
                        background: var(--card);
                        color: var(--secondary);
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.3s;
                }
                .mode-buttons button.active {
                        background: var(--secondary);
                        color: white;
                }
                #chat-container {
                        max-height: 60vh;
                        overflow-y: auto;
                        margin-bottom: 1rem;
                        padding: 1rem;
                        background: var(--bg);
                        border-radius: 8px;
                }
                .message {
                        margin-bottom: 1rem;
                        padding: 1rem;
                        border-radius: 12px;
                        max-width: 80%;
                }
                .user-message {
                        background: var(--secondary);
                        color: white;
                        align-self: flex-end;
                        margin-left: auto;
                }
                .ai-message {
                        background: #e9ecef;
                        align-self: flex-start;
                }
                body.dark .ai-message {
                        background: #2c2c2c;
                }
                #input-container {
                        display: flex;
                        gap: 1rem;
                }
                textarea {
                        flex: 1;
                        padding: 1rem;
                        border: 1px solid #ccc;
                        border-radius: 8px;
                        font-size: 1rem;
                        background: var(--card);
                        color: var(--text);
                }
                button.primary {
                        padding: 1rem 2rem;
                        background: var(--primary);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 1rem;
                        transition: background 0.3s;
                }
                button.primary:hover {
                        background: var(--accent);
                }
                #loader {
                        text-align: center;
                        padding: 2rem;
                        color: var(--muted);
                        font-size: 1.2rem;
                        display: none;
                }
        </style>
</head>
<body>
        <header>
                Canadia ‚Äî Comprendre. Structurer. D√©cider.
                <button id="theme-toggle" aria-label="Toggle dark mode">üåô</button>
        </header>
        <main>
                <div class="card">
                        <h2>Choisissez votre mode</h2>
                        <div class="mode-buttons">
                                <button onclick="setMode('citizen')" class="active">Citoyen</button>
                                <button onclick="setMode('student')">√âtudiant</button>
                                <button onclick="setMode('pro')">Entreprise</button>
                        </div>
                        <div id="context-card" style="display:none; margin-top:1rem;">
                                <label for="context">Contexte sp√©cifique</label>
                                <select id="context">
                                        <option value="general">G√©n√©ral</option>
                                        <option value="universite">Universit√©</option>
                                        <option value="entreprise">Entreprise</option>
                                </select>
                        </div>
                </div>

                <div class="card">
                        <h2>Votre conversation avec Canadia</h2>
                        <div id="chat-container"></div>
                        <div id="input-container">
                                <textarea id="question" placeholder="Posez votre question..." rows="3"></textarea>
                                <button class="primary" onclick="ask()">Envoyer</button>
                        </div>
                        <button class="primary" onclick="newConversation()" style="margin-top:1rem; width:100%;">Nouvelle conversation</button>
                </div>

                <div id="loader">Canadia r√©fl√©chit... ‚è≥</div>
        </main>

        <script>
                let mode = "citizen";
                let conversation = [];

                function setMode(m) {
                        mode = m;
                        document.querySelectorAll('.mode-buttons button').forEach(b => b.classList.remove('active'));
                        document.querySelector(`button[onclick=\"setMode('${m}')\"]`).classList.add('active');
                        document.getElementById('context-card').style.display = (m === "student" || m === "pro") ? "block" : "none";
                }

                function renderChat() {
                        const container = document.getElementById('chat-container');
                        container.innerHTML = '';
                        conversation.forEach(msg => {
                                const div = document.createElement('div');
                                div.className = `message ${msg.role}-message`;
                                if (msg.role === 'user') {
                                        div.textContent = msg.content;
                                } else {
                                        div.innerHTML = msg.content; // Permet HTML structur√© (r√©sum√©, points cl√©s, etc.)
                                }
                                container.appendChild(div);
                        });
                        container.scrollTop = container.scrollHeight;
                }

                async function ask() {
                        const question = document.getElementById('question').value.trim();
                        if (!question) return alert('Entrez une question !');

                        conversation.push({ role: 'user', content: question });
                        renderChat();
                        document.getElementById('question').value = '';
                        document.getElementById('loader').style.display = 'block';

                        try {
                                const context = document.getElementById('context')?.value || 'general';
                                const res = await fetch(`http://127.0.0.1:9000/${mode}/ask`, {  // √Ä adapter quand backend en ligne
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ question, context })
                                });
                                const data = await res.json();
                                let response = '<strong>R√©sum√© :</strong> ' + (data.summary || 'Pas de r√©sum√©.') + '<br><br>';
                                if (data.key_points) response += '<strong>Points cl√©s :</strong><ul><li>' + data.key_points.join('</li><li>') + '</li></ul>';
                                conversation.push({ role: 'assistant', content: response });
                                renderChat();
                        } catch (e) {
                                conversation.push({ role: 'assistant', content: 'Erreur : backend non accessible.' });
                                renderChat();
                        } finally {
                                document.getElementById('loader').style.display = 'none';
                        }
                }

                function newConversation() {
                        conversation = [];
                        renderChat();
                }

                // Th√®me
                document.getElementById('theme-toggle').onclick = () => {
                        document.body.classList.toggle('dark');
                        localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
                };
                if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');

                renderChat();
        </script>
</body>
</html>
                    function setMode(m) {
                            mode = m;
                            ["citizen", "student", "pro"].forEach(x => {
                                    document.getElementById("btn-" + x).classList.remove("active");
                            });
                            document.getElementById("btn-" + m).classList.add("active");
                            document.getElementById("context-card").style.display = (m === "student" || m === "pro") ? "block" : "none";
                    }

                    function toggleTheme() {
                            document.body.classList.toggle('dark');
                            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
                    }

                    function loadHistory() {
                            const list = document.getElementById('history-list');
                            list.innerHTML = '';
                            history.forEach((q, i) => {
                                    const li = document.createElement('li');
                                    li.textContent = q.substring(0, 50) + '...';
                                    li.onclick = () => document.getElementById('question').value = q;
                                    list.appendChild(li);
                            });
                            document.getElementById('history-card').style.display = history.length ? 'block' : 'none';
                    }

                    function addToHistory(q) {
                            history.push(q);
                            if (history.length > 10) history.shift(); // Limite √† 10
                            localStorage.setItem('canadiaHistory', JSON.stringify(history));
                            loadHistory();
                    }

                    function copyResponse() {
                            const resp = document.getElementById('response').innerText;
                            navigator.clipboard.writeText(resp).then(() => alert('R√©ponse copi√©e !'));
                    }

                    async function ask() {
                            const q = document.getElementById('question').value.trim();
                            if (!q) {
                                    alert('Veuillez entrer une question valide.');
                                    return;
                            }
                            document.getElementById('loader').style.display = 'block';
                            document.getElementById('response-card').style.display = 'none';
                            try {
                                    addToHistory(q);
                                    const context = document.getElementById('context').value; // Ajoute contexte si visible
                                    const body = { question: q, context }; // Envoie contexte au backend
                                    const res = await fetch(`http://127.0.0.1:9000/${mode}/ask`, {
                                            method: "POST",
                                            headers: { "Content-Type": "application/json" },
                                            body: JSON.stringify(body)
                                    });
                                    if (!res.ok) throw new Error('Erreur r√©seau');
                                    const data = await res.json();
                                    if (!data || Object.keys(data).length === 0) {
                                            document.getElementById('response').textContent = "Aucune r√©ponse disponible. Veuillez reformuler votre question ou r√©essayer plus tard.";
                                            return;
                                    }
                                    let html = "";
                                    if (data.title) html += `<strong>üß† ${data.title}</strong><br><br>`;
                                    if (data.summary) html += `<b>R√©sum√© :</b><br>${data.summary}<br><br>`;
                                    if (data.key_points && data.key_points.length) html += `<b>Points cl√©s :</b><ul>` + data.key_points.map(pt => `<li>${pt}</li>`).join("") + `</ul><br>`;
                                    if (data.analysis) html += `<b>Analyse :</b><br>${data.analysis}<br><br>`;
                                    if (data.actions_or_reflections && data.actions_or_reflections.length) html += `<b>Pour aller plus loin :</b><ul>` + data.actions_or_reflections.map(q => `<li>${q}</li>`).join("") + `</ul><br>`;
                                    if (data.sources && data.sources.length) html += `<b>Sources :</b><ul>` + data.sources.map(s => `<li>${s}</li>`).join("") + `</ul><br>`;
                                    if (data.limits) html += `<b>Limites :</b><br>${data.limits}<br><br>`;
                                    if (data.disclaimer) html += `<b>Note :</b> ${data.disclaimer}<br>`;
                                    document.getElementById('response').innerHTML = html || "Aucune r√©ponse structur√©e re√ßue.";
                                    document.getElementById('response-card').style.display = 'block';
                            } catch (e) {
                                    document.getElementById('response').textContent = `Erreur : ${e.message}. V√©rifiez le backend.`;
                                    document.getElementById('response-card').style.display = 'block';
                            } finally {
                                    document.getElementById('loader').style.display = 'none';
                            }
                    }

                    // Init
                    if (localStorage.getItem('theme') === 'dark') toggleTheme();
                    document.getElementById('theme-toggle').onclick = toggleTheme;
                    loadHistory();
            </script>
    </body>
    </html>
            document.getElementById("btn-" + m).classList.add("active");
            document.getElementById("context-card").style.display = (m === "student" || m === "pro") ? "block" : "none";
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }

        function loadHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            history.forEach((q, i) => {
                const li = document.createElement('li');
                li.textContent = q.substring(0, 50) + '...';
                li.onclick = () => document.getElementById('question').value = q;
                list.appendChild(li);
            });
            document.getElementById('history-card').style.display = history.length ? 'block' : 'none';
        }

        function addToHistory(q) {
            history.push(q);
            if (history.length > 10) history.shift(); // Limite √† 10
            localStorage.setItem('canadiaHistory', JSON.stringify(history));
            loadHistory();
        }

        function copyResponse() {
            const resp = document.getElementById('response').innerText;
            navigator.clipboard.writeText(resp).then(() => alert('R√©ponse copi√©e !'));
        }

        async function ask() {
            const q = document.getElementById('question').value.trim();
            if (!q) {
                alert('Veuillez entrer une question valide.');
                return;
            }
            document.getElementById('loader').style.display = 'block';
            document.getElementById('response-card').style.display = 'none';
            try {
                addToHistory(q);
                const context = document.getElementById('context').value; // Ajoute contexte si visible
                const body = { question: q, context }; // Envoie contexte au backend
                const res = await fetch(`http://127.0.0.1:9000/${mode}/ask`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });
                if (!res.ok) throw new Error('Erreur r√©seau');
                const data = await res.json();
                if (!data || Object.keys(data).length === 0) {
                    document.getElementById('response').textContent = "Aucune r√©ponse disponible. Veuillez reformuler votre question ou r√©essayer plus tard.";
                    return;
                }
                let html = "";
                if (data.title) html += `<strong>üß† ${data.title}</strong><br><br>`;
                if (data.summary) html += `<b>R√©sum√© :</b><br>${data.summary}<br><br>`;
                if (data.key_points && data.key_points.length) html += `<b>Points cl√©s :</b><ul>` + data.key_points.map(pt => `<li>${pt}</li>`).join("") + `</ul><br>`;
                if (data.analysis) html += `<b>Analyse :</b><br>${data.analysis}<br><br>`;
                if (data.actions_or_reflections && data.actions_or_reflections.length) html += `<b>Pour aller plus loin :</b><ul>` + data.actions_or_reflections.map(q => `<li>${q}</li>`).join("") + `</ul><br>`;
                if (data.sources && data.sources.length) html += `<b>Sources :</b><ul>` + data.sources.map(s => `<li>${s}</li>`).join("") + `</ul><br>`;
                if (data.limits) html += `<b>Limites :</b><br>${data.limits}<br><br>`;
                if (data.disclaimer) html += `<b>Note :</b> ${data.disclaimer}<br>`;
                document.getElementById('response').innerHTML = html || "Aucune r√©ponse structur√©e re√ßue.";
                document.getElementById('response-card').style.display = 'block';
            } catch (e) {
                document.getElementById('response').textContent = `Erreur : ${e.message}. V√©rifiez le backend.`;
                document.getElementById('response-card').style.display = 'block';
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // Init
        if (localStorage.getItem('theme') === 'dark') toggleTheme();
        document.getElementById('theme-toggle').onclick = toggleTheme;
        loadHistory();
    </script>
</body>
</html>
