

<!DOCTYPE html>
<html lang="fr">
<head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Canadia ‚Äî Comprendre. Structurer. D√©cider.</title>
        <style>
                :root {
                        --primary: #0b3c5d;
                        --secondary: #328cc1;
                        --accent: #d9b310;
                        --bg: #f8f9fc;
                        --surface: #ffffff;
                        --text: #1a1a1a;
                        --muted: #666666;
                }
                body.dark {
                        --bg: #0f172a;
                        --surface: #1e293b;
                        --text: #f1f5f9;
                        --muted: #94a3b8;
                }
                body {
                        margin: 0;
                        font-family: system-ui, -apple-system, sans-serif;
                        background: var(--bg);
                        color: var(--text);
                        min-height: 100vh;
                        display: flex;
                        flex-direction: column;
                        transition: background 0.3s, color 0.3s;
                }
                header {
                        background: var(--primary);
                        color: white;
                        padding: 1.5rem;
                        text-align: center;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                }
                .title {
                        font-size: 2rem;
                        font-weight: 600;
                        margin: 0;
                }
                .mode-selector {
                        display: flex;
                        justify-content: center;
                        gap: 1rem;
                        margin-top: 1.5rem;
                        flex-wrap: wrap;
                }
                .mode-btn {
                        padding: 0.8rem 1.8rem;
                        font-size: 1.1rem;
                        background: rgba(255,255,255,0.2);
                        border: none;
                        border-radius: 50px;
                        color: white;
                        cursor: pointer;
                        transition: all 0.3s;
                }
                .mode-btn.active {
                        background: white;
                        color: var(--primary);
                        font-weight: 600;
                }
                main {
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        padding: 2rem;
                }
                .search-container {
                        width: 100%;
                        max-width: 800px;
                        text-align: center;
                }
                .search-box {
                        width: 100%;
                        padding: 1.2rem 1.5rem;
                        font-size: 1.3rem;
                        border: 3px solid var(--secondary);
                        border-radius: 50px;
                        background: var(--surface);
                        color: var(--text);
                        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
                        outline: none;
                        transition: border-color 0.3s;
                }
                .search-box:focus {
                        border-color: var(--accent);
                }
                .search-btn {
                        margin-top: 1.5rem;
                        padding: 1rem 3rem;
                        font-size: 1.2rem;
                        background: var(--primary);
                        color: white;
                        border: none;
                        border-radius: 50px;
                        cursor: pointer;
                        box-shadow: 0 6px
                    function setMode(m) {
                            mode = m;
                            ["citizen", "student", "pro"].forEach(x => {
                                    document.getElementById("btn-" + x).classList.remove("active");
                            });
                            document.getElementById("btn-" + m).classList.add("active");
                            document.getElementById("context-card").style.display = (m === "student" || m === "pro") ? "block" : "none";
                    }

                    function toggleTheme() {
                            document.body.classList.toggle('dark');
                            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
                    }

                    function loadHistory() {
                            const list = document.getElementById('history-list');
                            list.innerHTML = '';
                            history.forEach((q, i) => {
                                    const li = document.createElement('li');
                                    li.textContent = q.substring(0, 50) + '...';
                                    li.onclick = () => document.getElementById('question').value = q;
                                    list.appendChild(li);
                            });
                            document.getElementById('history-card').style.display = history.length ? 'block' : 'none';
                    }

                    function addToHistory(q) {
                            history.push(q);
                            if (history.length > 10) history.shift(); // Limite √† 10
                            localStorage.setItem('canadiaHistory', JSON.stringify(history));
                            loadHistory();
                    }

                    function copyResponse() {
                            const resp = document.getElementById('response').innerText;
                            navigator.clipboard.writeText(resp).then(() => alert('R√©ponse copi√©e !'));
                    }

                    async function ask() {
                            const q = document.getElementById('question').value.trim();
                            if (!q) {
                                    alert('Veuillez entrer une question valide.');
                                    return;
                            }
                            document.getElementById('loader').style.display = 'block';
                            document.getElementById('response-card').style.display = 'none';
                            try {
                                    addToHistory(q);
                                    const context = document.getElementById('context').value; // Ajoute contexte si visible
                                    const body = { question: q, context }; // Envoie contexte au backend
                                    const res = await fetch(`http://127.0.0.1:9000/${mode}/ask`, {
                                            method: "POST",
                                            headers: { "Content-Type": "application/json" },
                                            body: JSON.stringify(body)
                                    });
                                    if (!res.ok) throw new Error('Erreur r√©seau');
                                    const data = await res.json();
                                    if (!data || Object.keys(data).length === 0) {
                                            document.getElementById('response').textContent = "Aucune r√©ponse disponible. Veuillez reformuler votre question ou r√©essayer plus tard.";
                                            return;
                                    }
                                    let html = "";
                                    if (data.title) html += `<strong>üß† ${data.title}</strong><br><br>`;
                                    if (data.summary) html += `<b>R√©sum√© :</b><br>${data.summary}<br><br>`;
                                    if (data.key_points && data.key_points.length) html += `<b>Points cl√©s :</b><ul>` + data.key_points.map(pt => `<li>${pt}</li>`).join("") + `</ul><br>`;
                                    if (data.analysis) html += `<b>Analyse :</b><br>${data.analysis}<br><br>`;
                                    if (data.actions_or_reflections && data.actions_or_reflections.length) html += `<b>Pour aller plus loin :</b><ul>` + data.actions_or_reflections.map(q => `<li>${q}</li>`).join("") + `</ul><br>`;
                                    if (data.sources && data.sources.length) html += `<b>Sources :</b><ul>` + data.sources.map(s => `<li>${s}</li>`).join("") + `</ul><br>`;
                                    if (data.limits) html += `<b>Limites :</b><br>${data.limits}<br><br>`;
                                    if (data.disclaimer) html += `<b>Note :</b> ${data.disclaimer}<br>`;
                                    document.getElementById('response').innerHTML = html || "Aucune r√©ponse structur√©e re√ßue.";
                                    document.getElementById('response-card').style.display = 'block';
                            } catch (e) {
                                    document.getElementById('response').textContent = `Erreur : ${e.message}. V√©rifiez le backend.`;
                                    document.getElementById('response-card').style.display = 'block';
                            } finally {
                                    document.getElementById('loader').style.display = 'none';
                            }
                    }

                    // Init
                    if (localStorage.getItem('theme') === 'dark') toggleTheme();
                    document.getElementById('theme-toggle').onclick = toggleTheme;
                    loadHistory();
            </script>
    </body>
    </html>
            document.getElementById("btn-" + m).classList.add("active");
            document.getElementById("context-card").style.display = (m === "student" || m === "pro") ? "block" : "none";
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }

        function loadHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            history.forEach((q, i) => {
                const li = document.createElement('li');
                li.textContent = q.substring(0, 50) + '...';
                li.onclick = () => document.getElementById('question').value = q;
                list.appendChild(li);
            });
            document.getElementById('history-card').style.display = history.length ? 'block' : 'none';
        }

        function addToHistory(q) {
            history.push(q);
            if (history.length > 10) history.shift(); // Limite √† 10
            localStorage.setItem('canadiaHistory', JSON.stringify(history));
            loadHistory();
        }

        function copyResponse() {
            const resp = document.getElementById('response').innerText;
            navigator.clipboard.writeText(resp).then(() => alert('R√©ponse copi√©e !'));
        }

        async function ask() {
            const q = document.getElementById('question').value.trim();
            if (!q) {
                alert('Veuillez entrer une question valide.');
                return;
            }
            document.getElementById('loader').style.display = 'block';
            document.getElementById('response-card').style.display = 'none';
            try {
                addToHistory(q);
                const context = document.getElementById('context').value; // Ajoute contexte si visible
                const body = { question: q, context }; // Envoie contexte au backend
                const res = await fetch(`http://127.0.0.1:9000/${mode}/ask`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });
                if (!res.ok) throw new Error('Erreur r√©seau');
                const data = await res.json();
                if (!data || Object.keys(data).length === 0) {
                    document.getElementById('response').textContent = "Aucune r√©ponse disponible. Veuillez reformuler votre question ou r√©essayer plus tard.";
                    return;
                }
                let html = "";
                if (data.title) html += `<strong>üß† ${data.title}</strong><br><br>`;
                if (data.summary) html += `<b>R√©sum√© :</b><br>${data.summary}<br><br>`;
                if (data.key_points && data.key_points.length) html += `<b>Points cl√©s :</b><ul>` + data.key_points.map(pt => `<li>${pt}</li>`).join("") + `</ul><br>`;
                if (data.analysis) html += `<b>Analyse :</b><br>${data.analysis}<br><br>`;
                if (data.actions_or_reflections && data.actions_or_reflections.length) html += `<b>Pour aller plus loin :</b><ul>` + data.actions_or_reflections.map(q => `<li>${q}</li>`).join("") + `</ul><br>`;
                if (data.sources && data.sources.length) html += `<b>Sources :</b><ul>` + data.sources.map(s => `<li>${s}</li>`).join("") + `</ul><br>`;
                if (data.limits) html += `<b>Limites :</b><br>${data.limits}<br><br>`;
                if (data.disclaimer) html += `<b>Note :</b> ${data.disclaimer}<br>`;
                document.getElementById('response').innerHTML = html || "Aucune r√©ponse structur√©e re√ßue.";
                document.getElementById('response-card').style.display = 'block';
            } catch (e) {
                document.getElementById('response').textContent = `Erreur : ${e.message}. V√©rifiez le backend.`;
                document.getElementById('response-card').style.display = 'block';
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // Init
        if (localStorage.getItem('theme') === 'dark') toggleTheme();
        document.getElementById('theme-toggle').onclick = toggleTheme;
        loadHistory();
    </script>
</body>
</html>
