<!DOCTYPE html>

<!DOCTYPE html>
<html lang="fr">
<head>
                <meta charset="UTF-8" />
                <title>Canadia ‚Äî Comprendre. Structurer. D√©cider.</title>
                <meta name="viewport" content="width=device-width, initial-scale=1" />
                <style>
                                :root {
                                                --primary: #0b3c5d;
                                                --secondary: #328cc1;
                                                --bg: #f5f7fa;
                                                --card: #ffffff;
                                                --text: #1a1a1a;
                                                --muted: #666;
                                                --accent: #d9b310;
                                                --error: #d9534f;
                                }
                                body {
                                                margin: 0;
                                                font-family: system-ui, -apple-system, BlinkMacSystemFont;
                                                background: var(--bg);
                                                color: var(--text);
                                                transition: background 0.3s, color 0.3s;
                                }
                                body.dark {
                                                --bg: #1e1e1e;
                                                --card: #2c2c2c;
                                                --text: #f0f0f0;
                                                --muted: #aaa;
                                }
                                header {
                                                background: var(--primary);
                                                color: white;
                                                padding: 20px;
                                                font-size: 22px;
                                                font-weight: 600;
                                                display: flex;
                                                justify-content: space-between;
                                                align-items: center;
                                }
                                #theme-toggle {
                                                background: none;
                                                border: none;
                                                color: white;
                                                font-size: 18px;
                                                cursor: pointer;
                                }
                                main {
                                                max-width: 900px;
                                                margin: 40px auto;
                                                padding: 0 20px;
                                }
                                .card {
                                                background: var(--card);
                                                border-radius: 8px;
                                                padding: 20px;
                                                margin-bottom: 25px;
                                                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                                                transition: box-shadow 0.3s;
                                }
                                .card:hover {
                                                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                                }
                                h2 {
                                                margin-top: 0;
                                                font-size: 20px;
                                }
                                .mode-buttons {
                                                display: flex;
                                                gap: 15px;
                                }
                                .mode-buttons button {
                                                flex: 1;
                                                padding: 15px;
                                                font-size: 16px;
                                                border: 2px solid var(--secondary);
                                                background: var(--card);
                                                color: var(--secondary);
                                                border-radius: 6px;
                                                cursor: pointer;
                                                transition: background 0.3s, color 0.3s;
                                }
                                .mode-buttons button.active {
                                                background: var(--secondary);
                                                color: white;
                                }
                                label {
                                                font-weight: 600;
                                                display: block;
                                                margin-bottom: 6px;
                                }
                                select, textarea {
                                                width: 100%;
                                                padding: 10px;
                                                font-size: 15px;
                                                border-radius: 5px;
                                                border: 1px solid #ccc;
                                                background: var(--card);
                                                color: var(--text);
                                }
                                textarea {
                                                resize: vertical;
                                                min-height: 40px;
                                                max-height: 120px;
                                }
                                button.primary {
                                                width: 100%;
                                                background: var(--primary);
                                                color: white;
                                                border: none;
                                                padding: 15px;
                                                font-size: 16px;
                                                border-radius: 6px;
                                                cursor: pointer;
                                                transition: background 0.3s;
                                }
                                button.primary:hover {
                                                background: var(--accent);
                                }
                                .response {
                                                white-space: pre-wrap;
                                                font-size: 15px;
                                                line-height: 1.5;
                                }
                                .muted {
                                                color: var(--muted);
                                                font-size: 14px;
                                }
                                #loader {
                                                display: none;
                                                text-align: center;
                                                padding: 10px;
                                                color: var(--muted);
                                }
                                #history-card {
                                                display: none;
                                }
                                #history-list {
                                                list-style: none;
                                                padding: 0;
                                }
                                #history-list li {
                                                padding: 10px;
                                                border-bottom: 1px solid #eee;
                                                cursor: pointer;
                                }
                                #copy-btn {
                                                background: var(--secondary);
                                                color: white;
                                                padding: 10px;
                                                border: none;
                                                border-radius: 4px;
                                                cursor: pointer;
                                                margin-top: 10px;
                                }
                                @media (max-width: 600px) {
                                                .mode-buttons {
                                                                flex-direction: column;
                                                }
                                }
                </style>
</head>
<body>
                <header>
                                Canadia ‚Äî Comprendre. Structurer. D√©cider.
                                <button id="theme-toggle" aria-label="Toggle dark mode">üåô</button>
                </header>
                <main>
                                <!-- Choix du mode -->
                                <div class="card">
                                                <h2>Choisissez votre espace</h2>
                                                <div class="mode-buttons">
                                                                <button onclick="setMode('citizen')" class="active" id="btn-citizen">Citoyen</button>
                                                                <button onclick="setMode('student')" id="btn-student">√âtudiant</button>
                                                                <button onclick="setMode('pro')" id="btn-pro">Entreprise</button>
                                                </div>
                                </div>
                                <!-- Contexte -->
                                <div class="card" id="context-card" style="display:none;">
                                                <h2>Contexte</h2>
                                                <label for="context">Niveau / Domaine</label>
                                                <select id="context">
                                                                <option value="general">G√©n√©ral</option>
                                                                <option value="universite">Universit√©</option>
                                                                <option value="entreprise">Entreprise</option>
                                                </select>
                                </div>
                                <!-- Question -->
                <!-- Nouvelle zone chat -->
                <div class="card">
                        <h2>Conversation avec Canadia</h2>
                        <div id="chat-container"></div>
                        <div id="input-container" style="display: flex; gap: 10px; align-items: flex-end;">
                                <textarea id="question" placeholder="Posez votre question ou continuez la discussion..." aria-label="Votre message"></textarea>
                                <button class="primary" id="send-btn" onclick="ask()" style="width: auto; padding: 0 24px; height: 40px;">Envoyer</button>
                        </div>
                        <button class="primary" id="new-analysis" onclick="newConversation()">Nouvelle analyse</button>
                </div>
                <div id="loader" style="display:none; text-align:center; padding:20px; font-size:18px; letter-spacing:1px;">Canadia r√©fl√©chit... ‚è≥</div>
                                <!-- Historique -->
                                <div class="card" id="history-card">
                                                <h2>Historique des questions</h2>
                                                <ul id="history-list"></ul>
                                </div>
                </main>
                <script>
        let mode = "citizen";
        let conversation = [];

        function setMode(m) {
                mode = m;
                ["citizen","student","pro"].forEach(x => document.getElementById("btn-"+x).classList.remove("active"));
                document.getElementById("btn-"+m).classList.add("active");
                document.getElementById("context-card").style.display = (m === "student" || m === "pro") ? "block" : "none";
        }

        function renderChat() {
                const container = document.getElementById("chat-container");
                container.innerHTML = "";
                conversation.forEach((msg, idx) => {
                        const div = document.createElement("div");
                        div.className = "message " + (msg.role === "user" ? "user-message" : "ai-message");
                        if (msg.role === "user") {
                                div.textContent = msg.content;
                        } else {
                                let html = "";
                                const data = msg.structured;
                                if (data.title) html += `<strong>üß† ${data.title}</strong><br><br>`;
                                if (data.summary) html += `<b>R√©sum√© :</b><br>${data.summary}<br><br>`;
                                if (data.key_points?.length) html += `<b>Points cl√©s :</b><ul>${data.key_points.map(p => `<li>${p}</li>`).join("")}</ul><br>`;
                                if (data.analysis) html += `<b>Analyse :</b><br>${data.analysis}<br><br>`;
                                if (data.actions_or_reflections?.length) html += `<b>Pour aller plus loin :</b><ul>${data.actions_or_reflections.map(a => `<li>${a}</li>`).join("")}</ul><br>`;
                                if (data.sources?.length) html += `<b>Sources :</b><ul>${data.sources.map(s => `<li>${s}</li>`).join("")}</ul><br>`;
                                if (data.limits) html += `<b>Limites :</b><br>${data.limits}<br><br>`;
                                if (data.disclaimer) html += `<b>Note :</b> ${data.disclaimer}`;
                                div.innerHTML = html || "R√©ponse non structur√©e.";
                                // Ajout bouton copier
                                const copyBtn = document.createElement('button');
                                copyBtn.className = 'copy-btn';
                                copyBtn.textContent = 'Copier';
                                copyBtn.onclick = () => {
                                    navigator.clipboard.writeText(
                                        data.summary + '\n' +
                                        (data.key_points?.join('\n') || '') + '\n' +
                                        (data.analysis || '')
                                    );
                                    copyBtn.textContent = 'Copi√©!';
                                    setTimeout(() => copyBtn.textContent = 'Copier', 1200);
                                };
                                div.appendChild(copyBtn);
                        }
                        container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
        }

        async function ask() {
                const q = document.getElementById('question').value.trim();
                if (!q) {
                        alert('Veuillez entrer une question valide.');
                        return;
                }
                conversation.push({role: "user", content: q});
                renderChat();
                document.getElementById('question').value = "";
                document.getElementById('loader').style.display = 'block';
                try {
                        const context = document.getElementById('context').value;
                        const body = { question: q, context };
                        const res = await fetch(`http://127.0.0.1:9000/${mode}/ask`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(body)
                        });
                        if (!res.ok) throw new Error('Erreur r√©seau');
                        const data = await res.json();
                        conversation.push({role: "assistant", structured: data});
                        renderChat();
                } catch (e) {
                        conversation.push({role: "assistant", structured: {summary: `Erreur : ${e.message}. V√©rifiez le backend.`}});
                        renderChat();
                } finally {
                        document.getElementById('loader').style.display = 'none';
                }
        }

        function newConversation() {
                conversation = [];
                renderChat();
        }

        function toggleTheme() {
                document.body.classList.toggle('dark');
                localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }

        // Init
        if (localStorage.getItem('theme') === 'dark') toggleTheme();
        document.getElementById('theme-toggle').onclick = toggleTheme;
        renderChat();
                </script>
</body>
</html>
                    function setMode(m) {
                            mode = m;
                            ["citizen", "student", "pro"].forEach(x => {
                                    document.getElementById("btn-" + x).classList.remove("active");
                            });
                            document.getElementById("btn-" + m).classList.add("active");
                            document.getElementById("context-card").style.display = (m === "student" || m === "pro") ? "block" : "none";
                    }

                    function toggleTheme() {
                            document.body.classList.toggle('dark');
                            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
                    }

                    function loadHistory() {
                            const list = document.getElementById('history-list');
                            list.innerHTML = '';
                            history.forEach((q, i) => {
                                    const li = document.createElement('li');
                                    li.textContent = q.substring(0, 50) + '...';
                                    li.onclick = () => document.getElementById('question').value = q;
                                    list.appendChild(li);
                            });
                            document.getElementById('history-card').style.display = history.length ? 'block' : 'none';
                    }

                    function addToHistory(q) {
                            history.push(q);
                            if (history.length > 10) history.shift(); // Limite √† 10
                            localStorage.setItem('canadiaHistory', JSON.stringify(history));
                            loadHistory();
                    }

                    function copyResponse() {
                            const resp = document.getElementById('response').innerText;
                            navigator.clipboard.writeText(resp).then(() => alert('R√©ponse copi√©e !'));
                    }

                    async function ask() {
                            const q = document.getElementById('question').value.trim();
                            if (!q) {
                                    alert('Veuillez entrer une question valide.');
                                    return;
                            }
                            document.getElementById('loader').style.display = 'block';
                            document.getElementById('response-card').style.display = 'none';
                            try {
                                    addToHistory(q);
                                    const context = document.getElementById('context').value; // Ajoute contexte si visible
                                    const body = { question: q, context }; // Envoie contexte au backend
                                    const res = await fetch(`http://127.0.0.1:9000/${mode}/ask`, {
                                            method: "POST",
                                            headers: { "Content-Type": "application/json" },
                                            body: JSON.stringify(body)
                                    });
                                    if (!res.ok) throw new Error('Erreur r√©seau');
                                    const data = await res.json();
                                    if (!data || Object.keys(data).length === 0) {
                                            document.getElementById('response').textContent = "Aucune r√©ponse disponible. Veuillez reformuler votre question ou r√©essayer plus tard.";
                                            return;
                                    }
                                    let html = "";
                                    if (data.title) html += `<strong>üß† ${data.title}</strong><br><br>`;
                                    if (data.summary) html += `<b>R√©sum√© :</b><br>${data.summary}<br><br>`;
                                    if (data.key_points && data.key_points.length) html += `<b>Points cl√©s :</b><ul>` + data.key_points.map(pt => `<li>${pt}</li>`).join("") + `</ul><br>`;
                                    if (data.analysis) html += `<b>Analyse :</b><br>${data.analysis}<br><br>`;
                                    if (data.actions_or_reflections && data.actions_or_reflections.length) html += `<b>Pour aller plus loin :</b><ul>` + data.actions_or_reflections.map(q => `<li>${q}</li>`).join("") + `</ul><br>`;
                                    if (data.sources && data.sources.length) html += `<b>Sources :</b><ul>` + data.sources.map(s => `<li>${s}</li>`).join("") + `</ul><br>`;
                                    if (data.limits) html += `<b>Limites :</b><br>${data.limits}<br><br>`;
                                    if (data.disclaimer) html += `<b>Note :</b> ${data.disclaimer}<br>`;
                                    document.getElementById('response').innerHTML = html || "Aucune r√©ponse structur√©e re√ßue.";
                                    document.getElementById('response-card').style.display = 'block';
                            } catch (e) {
                                    document.getElementById('response').textContent = `Erreur : ${e.message}. V√©rifiez le backend.`;
                                    document.getElementById('response-card').style.display = 'block';
                            } finally {
                                    document.getElementById('loader').style.display = 'none';
                            }
                    }

                    // Init
                    if (localStorage.getItem('theme') === 'dark') toggleTheme();
                    document.getElementById('theme-toggle').onclick = toggleTheme;
                    loadHistory();
            </script>
    </body>
    </html>
            document.getElementById("btn-" + m).classList.add("active");
            document.getElementById("context-card").style.display = (m === "student" || m === "pro") ? "block" : "none";
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }

        function loadHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            history.forEach((q, i) => {
                const li = document.createElement('li');
                li.textContent = q.substring(0, 50) + '...';
                li.onclick = () => document.getElementById('question').value = q;
                list.appendChild(li);
            });
            document.getElementById('history-card').style.display = history.length ? 'block' : 'none';
        }

        function addToHistory(q) {
            history.push(q);
            if (history.length > 10) history.shift(); // Limite √† 10
            localStorage.setItem('canadiaHistory', JSON.stringify(history));
            loadHistory();
        }

        function copyResponse() {
            const resp = document.getElementById('response').innerText;
            navigator.clipboard.writeText(resp).then(() => alert('R√©ponse copi√©e !'));
        }

        async function ask() {
            const q = document.getElementById('question').value.trim();
            if (!q) {
                alert('Veuillez entrer une question valide.');
                return;
            }
            document.getElementById('loader').style.display = 'block';
            document.getElementById('response-card').style.display = 'none';
            try {
                addToHistory(q);
                const context = document.getElementById('context').value; // Ajoute contexte si visible
                const body = { question: q, context }; // Envoie contexte au backend
                const res = await fetch(`http://127.0.0.1:9000/${mode}/ask`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });
                if (!res.ok) throw new Error('Erreur r√©seau');
                const data = await res.json();
                if (!data || Object.keys(data).length === 0) {
                    document.getElementById('response').textContent = "Aucune r√©ponse disponible. Veuillez reformuler votre question ou r√©essayer plus tard.";
                    return;
                }
                let html = "";
                if (data.title) html += `<strong>üß† ${data.title}</strong><br><br>`;
                if (data.summary) html += `<b>R√©sum√© :</b><br>${data.summary}<br><br>`;
                if (data.key_points && data.key_points.length) html += `<b>Points cl√©s :</b><ul>` + data.key_points.map(pt => `<li>${pt}</li>`).join("") + `</ul><br>`;
                if (data.analysis) html += `<b>Analyse :</b><br>${data.analysis}<br><br>`;
                if (data.actions_or_reflections && data.actions_or_reflections.length) html += `<b>Pour aller plus loin :</b><ul>` + data.actions_or_reflections.map(q => `<li>${q}</li>`).join("") + `</ul><br>`;
                if (data.sources && data.sources.length) html += `<b>Sources :</b><ul>` + data.sources.map(s => `<li>${s}</li>`).join("") + `</ul><br>`;
                if (data.limits) html += `<b>Limites :</b><br>${data.limits}<br><br>`;
                if (data.disclaimer) html += `<b>Note :</b> ${data.disclaimer}<br>`;
                document.getElementById('response').innerHTML = html || "Aucune r√©ponse structur√©e re√ßue.";
                document.getElementById('response-card').style.display = 'block';
            } catch (e) {
                document.getElementById('response').textContent = `Erreur : ${e.message}. V√©rifiez le backend.`;
                document.getElementById('response-card').style.display = 'block';
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // Init
        if (localStorage.getItem('theme') === 'dark') toggleTheme();
        document.getElementById('theme-toggle').onclick = toggleTheme;
        loadHistory();
    </script>
</body>
</html>
